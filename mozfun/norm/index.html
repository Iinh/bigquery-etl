<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Mozilla Data Platform Team">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>norm - BigQuery ETL</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BigQuery ETL</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">BigQuery ETL</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Mozfun <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../bits28/" class="dropdown-item">bits28</a>
</li>
                                    
<li>
    <a href="../event_analysis/" class="dropdown-item">event_analysis</a>
</li>
                                    
<li>
    <a href="../glean/" class="dropdown-item">glean</a>
</li>
                                    
<li>
    <a href="../hist/" class="dropdown-item">hist</a>
</li>
                                    
<li>
    <a href="../json/" class="dropdown-item">json</a>
</li>
                                    
<li>
    <a href="../map/" class="dropdown-item">map</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">norm</a>
</li>
                                    
<li>
    <a href="../overview/" class="dropdown-item">mozfun</a>
</li>
                                    
<li>
    <a href="../stats/" class="dropdown-item">stats</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../map/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../overview/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/mozilla/bigquery-etl/edit/master/docs/mozfun/norm.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#norm" class="nav-link">norm</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#metadata-udf" class="nav-link">metadata (UDF)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#fenix_app_info-udf" class="nav-link">fenix_app_info (UDF)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#product_info-udf" class="nav-link">product_info (UDF)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#glean_ping_info-udf" class="nav-link">glean_ping_info (UDF)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#glean_baseline_client_info-udf" class="nav-link">glean_baseline_client_info (UDF)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#os-udf" class="nav-link">os (UDF)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="norm">norm</h1>
<p>Functions for normalizing data.</p>
<h2 id="metadata-udf">metadata (UDF)</h2>
<p>Accepts a pipeline metadata struct as input and returns a modified struct that includes a few parsed or normalized variants of the input metadata fields.</p>
<h2 id="fenix_app_info-udf">fenix_app_info (UDF)</h2>
<p>Returns canonical, human-understandable identification info for Fenix sources.</p>
<p>The Glean telemetry library for Android by design routes pings based on the Play Store
appId value of the published application.
As of August 2020, there have been 5 separate Play Store appId values associated
with different builds of Fenix, each corresponding to different datasets in BigQuery,
and the mapping of appId to logical app names (Firefox vs. Firefox Preview) and
channel names (nightly, beta, or release) has changed over time; see the
<a href="https://docs.google.com/spreadsheets/d/18PzkzZxdpFl23__-CIO735NumYDqu7jHpqllo0sBbPA/edit#gid=0">spreadsheet of naming history for Mozilla's mobile browsers</a>.</p>
<p>This function is intended as the source of truth for how to map a specific ping
in BigQuery to a logical app names and channel.
It should be expected that the output of this function may evolve over time.
If we rename a product or channel, we may choose to update the values here so
that analyses consistently get the new name.</p>
<p>The first argument (<code>app_id</code>) can be fairly fuzzy; it is tolerant of actual Google
Play Store appId values like 'org.mozilla.firefox_beta' (mix of periods and underscores)
as well as BigQuery dataset names with suffixes like 'org_mozilla_firefox_beta_stable'.</p>
<p>The second argument (<code>app_build_id</code>) should be the value in client_info.app_build.</p>
<p>The function returns a <code>STRUCT</code> that contains the logical <code>app_name</code> and <code>channel</code> as well as
the Play Store <code>app_id</code> in the canonical form which would appear in Play Store URLs.</p>
<p>Note that the naming of Fenix applications changed on 2020-07-03, so to get a continuous
view of the pings associated with a logical app channel, you may need to union together
tables from multiple BigQuery datasets. To see data for all Fenix channels together, it
is necessary to union together tables from all 5 datasets. For basic usage information,
consider using <code>telemetry.fenix_clients_last_seen</code> which already handles the union.
Otherwise, see the example below as a template for how construct a custom union.</p>
<p>Mapping of channels to datasets:</p>
<ul>
<li>release: <code>org_mozilla_firefox</code></li>
<li>beta: <code>org_mozilla_firefox_beta</code> (current) and <code>org_mozilla_fenix</code></li>
<li>nightly: <code>org_mozilla_fenix</code> (current), <code>org_mozilla_fennec_aurora</code>, and <code>org_mozilla_fenix_nightly</code></li>
</ul>
<pre><code class="language-sql">-- Example of a query over all Fenix builds advertised as &quot;Firefox Beta&quot;
CREATE TEMP FUNCTION extract_fields(app_id STRING, m ANY TYPE) AS (
  (
    SELECT AS STRUCT
      m.submission_timestamp,
      m.metrics.string.geckoview_version,
      mozfun.norm.fenix_app_info(app_id, m.client_info.app_build).*
  )
);

WITH base AS (
  SELECT
    extract_fields('org_mozilla_firefox_beta', m).*
  FROM
    org_mozilla_firefox_beta.metrics AS m
  UNION ALL
  SELECT
    extract_fields('org_mozilla_fenix', m).*
  FROM
    org_mozilla_fenix.metrics AS m
)
SELECT
  DATE(submission_timestamp) AS submission_date,
  geckoview_version,
  COUNT(*)
FROM
  base
WHERE
  app_name = 'Fenix'  -- excludes 'Firefox Preview'
  AND channel = 'beta'
  AND DATE(submission_timestamp) = '2020-08-01'
GROUP BY
  submission_date,
  geckoview_version
</code></pre>
<h2 id="product_info-udf">product_info (UDF)</h2>
<p>Returns a normalized <code>product</code> name and a <code>canonical_name</code> for a product
based on the raw <code>app_name</code> and <code>normalized_os</code> values that appear in pings.</p>
<p>The returned <code>product</code> name is intended to be readable and unambiguous, but
short and easy to type. This value is suitable for use as a key in derived
tables.</p>
<p>The returned <code>canonical_name</code> is more verbose and is suited for displaying
in visualizations.</p>
<p>The returned struct also contains boolean <code>contributes_to_2020_kpi</code> as the
canonical reference for whether the given application is included in KPI
reporting. Additional fields may be added for future years.</p>
<p>The <code>normalized_os</code> value that's passed in should be the top-level <code>normalized_os</code>
value present in any ping table or you may want to wrap a raw value in <code>mozfun.norm.os</code>
like <code>mozfun.norm.product_info(app_name, mozfun.norm.os(os))</code>.</p>
<p>For legacy telemetry pings like <code>main</code> ping for desktop and <code>core</code> ping for
mobile products, <code>app_name</code> should come from the submission URI (stored as
<code>metadata.uri.app_name</code> in BigQuery ping tables).</p>
<p>For Glean pings, the concept of an <code>app_name</code> doesn't exist, since pings
from different applications are routed to different BigQuery datasets.
Instead, the <code>app_name</code> send in for Glean pings should be the same value as
what's expected for <code>product</code>. So, a view on top of pings from Fenix should
pass in "Fenix" for <code>app_name</code>.</p>
<p>This function also tolerates passing in a <code>product</code> value as <code>app_name</code> so that
this function is still useful for derived tables which have thrown away the
raw <code>app_name</code> value.</p>
<p>The mappings are as follows:</p>
<table>
<thead>
<tr>
<th>app_name</th>
<th>normalized_os</th>
<th>product</th>
<th>canonical_name</th>
<th>2019</th>
<th>2020</th>
</tr>
</thead>
<tbody>
<tr>
<td>Firefox</td>
<td>*</td>
<td>Firefox</td>
<td>Firefox for Desktop</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>Fenix</td>
<td>Android</td>
<td>Fenix</td>
<td>Firefox for Android (Fenix)</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>Fennec</td>
<td>Android</td>
<td>Fennec</td>
<td>Firefox for Android (Fennec)</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>Firefox Preview</td>
<td>Android</td>
<td>Firefox Preview</td>
<td>Firefox Preview for Android</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>Fennec</td>
<td>iOS</td>
<td>Firefox iOS</td>
<td>Firefox for iOS</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>FirefoxForFireTV</td>
<td>Android</td>
<td>Firefox Fire TV</td>
<td>Firefox for Fire TV</td>
<td>false</td>
<td>false</td>
</tr>
<tr>
<td>FirefoxConnect</td>
<td>Android</td>
<td>Firefox Echo</td>
<td>Firefox for Echo Show</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>Zerda</td>
<td>Android</td>
<td>Firefox Lite</td>
<td>Firefox Lite</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>Zerda_cn</td>
<td>Android</td>
<td>Firefox Lite CN</td>
<td>Firefox Lite (China)</td>
<td>false</td>
<td>false</td>
</tr>
<tr>
<td>Focus</td>
<td>Android</td>
<td>Focus Android</td>
<td>Firefox Focus for Android</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>Focus</td>
<td>iOS</td>
<td>Focus iOS</td>
<td>Firefox Focus for iOS</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>Klar</td>
<td>Android</td>
<td>Klar Android</td>
<td>Firefox Klar for Android</td>
<td>false</td>
<td>false</td>
</tr>
<tr>
<td>Klar</td>
<td>iOS</td>
<td>Klar iOS</td>
<td>Firefox Klar for iOS</td>
<td>false</td>
<td>false</td>
</tr>
<tr>
<td>Lockbox</td>
<td>Android</td>
<td>Lockwise Android</td>
<td>Lockwise for Android</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>Lockbox</td>
<td>iOS</td>
<td>Lockwise iOS</td>
<td>Lockwise for iOS</td>
<td>true</td>
<td>true</td>
</tr>
<tr>
<td>FirefoxReality*</td>
<td>Android</td>
<td>Firefox Reality</td>
<td>Firefox Reality</td>
<td>true</td>
<td>true</td>
</tr>
</tbody>
</table>
<h2 id="glean_ping_info-udf">glean_ping_info (UDF)</h2>
<p>Accepts a glean ping_info struct as input and returns a modified struct that includes a few parsed or normalized variants of the input fields.</p>
<h2 id="glean_baseline_client_info-udf">glean_baseline_client_info (UDF)</h2>
<p>Accepts a glean client_info struct as input and returns a modified struct that includes a few parsed or normalized variants of the input fields.</p>
<h2 id="os-udf">os (UDF)</h2>
<p>Normalize an operating system string to one of the three major desktop
platforms, one of the two major mobile platforms, or "Other". </p>
<p>This is a reimplementation of <a href="https://github.com/mozilla/gcp-ingestion/blob/a6928fb089f1652856147c4605df715f327edfcd/ingestion-beam/src/main/java/com/mozilla/telemetry/transforms/NormalizeAttributes.java#L52-L74">logic used in the data pipeline</a> to populate <code>normalized_os</code>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
